# å¾®åšçƒ­æœè¶‹åŠ¿åˆ†æå™¨ - GitHub Actions å®šæ—¶æ‰§è¡Œå·¥ä½œæµ
# ä½¿ç”¨ Claude Agent SDK è¿›è¡Œæ™ºèƒ½åˆ†æ

name: å¾®åšçƒ­æœè¶‹åŠ¿åˆ†æ

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹æ‰§è¡Œ (UTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´+8å°æ—¶)
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00 = åŒ—äº¬æ—¶é—´ 08:00
    - cron: '0 12 * * *'  # UTC 12:00 = åŒ—äº¬æ—¶é—´ 20:00
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      hotspot_count:
        description: 'åˆ†æçƒ­æœæ•°é‡'
        required: false
        default: '10'
      use_claude:
        description: 'ä½¿ç”¨Claudeæ™ºèƒ½åˆ†æ'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PYTHON_VERSION: '3.11'
  REPORTS_DIR: 'reports'

jobs:
  analyze-trends:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # å…è®¸æäº¤æŠ¥å‘Šåˆ°ä»“åº“
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. åˆ›å»ºæŠ¥å‘Šç›®å½•
      - name: åˆ›å»ºæŠ¥å‘Šç›®å½•
        run: mkdir -p ${{ env.REPORTS_DIR }}
      
      # 5. è¿è¡Œå¾®åšçƒ­æœåˆ†æï¼ˆä½¿ç”¨Claude Agent SDKï¼‰
      - name: è¿è¡Œå¾®åšçƒ­æœåˆ†æ
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          HOTSPOT_COUNT: ${{ github.event.inputs.hotspot_count || '10' }}
          USE_CLAUDE: ${{ github.event.inputs.use_claude || 'true' }}
        run: |
          python src/weibo_trends_analyzer.py \
            --number $HOTSPOT_COUNT \
            --output ${{ env.REPORTS_DIR }}/report_$(date +%Y%m%d_%H%M%S).md \
            --use-claude $USE_CLAUDE
      
      # 6. ç”Ÿæˆæ‘˜è¦
      - name: ç”Ÿæˆå·¥ä½œæµæ‘˜è¦
        run: |
          echo "## ğŸ”¥ å¾®åšçƒ­æœåˆ†æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æœ€æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # æ˜¾ç¤ºæœ€æ–°æŠ¥å‘Šå†…å®¹
          LATEST_REPORT=$(ls -t ${{ env.REPORTS_DIR }}/report_*.md 2>/dev/null | head -1)
          if [ -f "$LATEST_REPORT" ]; then
            cat "$LATEST_REPORT" >> $GITHUB_STEP_SUMMARY
          fi
      
      # 7. æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      - name: æäº¤æŠ¥å‘Šåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ env.REPORTS_DIR }}/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„æŠ¥å‘Šéœ€è¦æäº¤"
          else
            git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°å¾®åšçƒ­æœåˆ†ææŠ¥å‘Š - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')"
            git push
          fi
      
      # 8. ä¸Šä¼ æŠ¥å‘Šä½œä¸º Artifactï¼ˆå¯é€‰ï¼Œä¿ç•™30å¤©ï¼‰
      - name: ä¸Šä¼ æŠ¥å‘Š Artifact
        uses: actions/upload-artifact@v4
        with:
          name: weibo-trends-report-${{ github.run_number }}
          path: ${{ env.REPORTS_DIR }}/
          retention-days: 30

  # å¯é€‰ï¼šå‘é€é€šçŸ¥ Job
  notify:
    needs: analyze-trends
    runs-on: ubuntu-latest
    if: ${{ always() && needs.analyze-trends.result != 'cancelled' }}
    
    steps:
      - name: å‘é€æ‰§è¡Œç»“æœé€šçŸ¥
        run: |
          if [ "${{ needs.analyze-trends.result }}" == "success" ]; then
            echo "âœ… å¾®åšçƒ­æœåˆ†ææˆåŠŸå®Œæˆï¼"
          else
            echo "âŒ å¾®åšçƒ­æœåˆ†ææ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          fi
          # è¿™é‡Œå¯ä»¥æ·»åŠ é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é‚®ä»¶ç­‰é€šçŸ¥é€»è¾‘
